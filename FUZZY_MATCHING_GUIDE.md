# Fuzzy Matching ì—”ì§„ ê°€ì´ë“œ

## ğŸ“Œ ê°œìš”

ì‚¬ìš©ì ì§ˆë¬¸ì—ì„œ **ë„ì–´ì“°ê¸° ì˜¤ë¥˜**, **ì˜¤íƒˆì**, **ì¡°ì‚¬ ë³€ê²½**ì„ ìë™ìœ¼ë¡œ ë³´ì •í•˜ì—¬ ê´€ë ¨ ìš©ì–´ë¥¼ ì°¾ëŠ” Fuzzy Matching ì—”ì§„ì…ë‹ˆë‹¤.

**ì ìš© ìœ„ì¹˜**: `/api/chat` ì—”ë“œí¬ì¸íŠ¸ì˜ ìš©ì–´ ê²€ìƒ‰ ë‹¨ê³„ (Step 3)

---

## âœ¨ ì£¼ìš” ê¸°ëŠ¥

### 1. **ë„ì–´ì“°ê¸° ë³´ì •**

```
ì…ë ¥: "í´ë¡œë²„ëŠ”ì–´ë””ì—ì“°ë‚˜ìš”?"
     â†“ ì •ê·œí™”
ì¶œë ¥: "í´ë¡œë²„" ë§¤ì¹­ ì„±ê³µ (exact:1.00)
```

```
ì…ë ¥: "í¬ ì½” ì½” ë¡œ"
     â†“ ì •ê·œí™”
ì¶œë ¥: "í¬ì½”ì½”ë¡œ" ë§¤ì¹­ ì„±ê³µ (exact:1.00)
```

### 2. **ì˜¤íƒˆì ë³´ì •**

```
ì…ë ¥: "í´ë¡œë°”ëŠ” ë­ì•¼?" (ë°” â†’ ë²„ ì˜¤íƒ€)
     â†“ ìœ ì‚¬ë„ ê³„ì‚°: 82%
ì¶œë ¥: "í´ë¡œë²„" ë§¤ì¹­ ì„±ê³µ (fuzzy:0.82)
```

### 3. **ì¡°ì‚¬ ë³€ê²½ ëŒ€ì‘**

```
ì…ë ¥: "í´ë¡œë²„ë¥¼ ì–´ë–»ê²Œ ì–»ì–´?"
     â†“ ì¡°ì‚¬ ì œê±°: "í´ë¡œë²„ë¥¼" â†’ "í´ë¡œë²„"
ì¶œë ¥: "í´ë¡œë²„" ë§¤ì¹­ ì„±ê³µ (exact:1.00)
```

---

## ğŸ”§ ê¸°ìˆ  êµ¬í˜„

### ì•„í‚¤í…ì²˜

```
ì‚¬ìš©ì ì§ˆë¬¸
    â†“
[1] í…ìŠ¤íŠ¸ ì •ê·œí™” (normalize_korean_text)
    - ì¡°ì‚¬ ì œê±°: ì€/ëŠ”/ì´/ê°€/ì„/ë¥¼/...
    - ë„ì–´ì“°ê¸° ì œê±°
    - ì†Œë¬¸ì ë³€í™˜
    â†“
[2] ìš©ì–´ ë§¤ì¹­ (find_matching_terms)
    - Method 1: ì •í™• ë§¤ì¹­ (exact)
    - Method 2: Fuzzy ë§¤ì¹­ (similarity >= 65%)
    â†“
[3] ìœ ì‚¬ë„ ê³„ì‚° (fuzzy_similarity)
    - SequenceMatcher ê¸°ë°˜
    - ì§§ì€ ë‹¨ì–´ ë³´ì • (3ê¸€ì ì´í•˜)
    - ì²« ê¸€ì ë³´ë„ˆìŠ¤
    â†“
ê²°ê³¼: ë§¤ì¹­ëœ ìš©ì–´ ë¦¬ìŠ¤íŠ¸ (ì‹ ë¢°ë„ ìˆœ ì •ë ¬)
```

### í•µì‹¬ í•¨ìˆ˜

#### 1. `normalize_korean_text(text: str) -> str`

í•œêµ­ì–´ í…ìŠ¤íŠ¸ë¥¼ ì •ê·œí™”í•©ë‹ˆë‹¤.

**ì²˜ë¦¬ ë‚´ìš©**:
- ì†Œë¬¸ì ë³€í™˜
- í•œêµ­ì–´ ì¡°ì‚¬ ì œê±° (ë‹¨ì–´ ëì—ì„œë§Œ)
  - 2ìŒì ˆ ì¡°ì‚¬: ì—ì„œëŠ”, ì—ì„œë„, ìœ¼ë¡œëŠ”, ...
  - 1ìŒì ˆ ì¡°ì‚¬: ì€, ëŠ”, ì´, ê°€, ì„, ë¥¼, ...
- ë„ì–´ì“°ê¸° ì œê±°

**ì˜ˆì‹œ**:
```python
normalize_korean_text("í´ë¡œë²„ëŠ” ì–´ë””ì—ì„œ")
# â†’ "í´ë¡œë²„"

normalize_korean_text("í¬ ì½” ì½” ë¡œ")
# â†’ "í¬ì½”ì½”ë¡œ"
```

#### 2. `fuzzy_similarity(str1: str, str2: str) -> float`

ë‘ ë¬¸ìì—´ì˜ ìœ ì‚¬ë„ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤ (0.0 ~ 1.0).

**ì•Œê³ ë¦¬ì¦˜**:
1. **ê¸°ë³¸ ìœ ì‚¬ë„**: `SequenceMatcher` ì‚¬ìš©
2. **ê¸¸ì´ ë³´ì •**: ê¸¸ì´ ì°¨ì´ê°€ 1 ì´í•˜ + ì²« ê¸€ì ê°™ìŒ â†’ +15% ë³´ë„ˆìŠ¤
3. **ì§§ì€ ë‹¨ì–´ ë³´ì •** (3ê¸€ì ì´í•˜):
   - 1ê¸€ì ì°¨ì´ â†’ 0.8
   - 2ê¸€ì ì°¨ì´ â†’ 0.6

**ì˜ˆì‹œ**:
```python
fuzzy_similarity("í´ë¡œë°”", "í´ë¡œë²„")
# â†’ 0.82 (82% ìœ ì‚¬)

fuzzy_similarity("í¬ì½”ë¡œ", "í¬ì½”ì½”ë¡œ")
# â†’ 0.75 (75% ìœ ì‚¬)
```

#### 3. `find_matching_terms(user_query, all_terms, exact_threshold=0.85, fuzzy_threshold=0.65)`

ì‚¬ìš©ì ì§ˆë¬¸ì—ì„œ ê´€ë ¨ ìš©ì–´ë¥¼ ì°¾ìŠµë‹ˆë‹¤.

**ë§¤ì¹­ ë°©ë²•**:
1. **ì •í™• ë§¤ì¹­** (exact):
   - ì›ë³¸ ë¬¸ìì—´ í¬í•¨: `"í´ë¡œë²„" in "í´ë¡œë²„ëŠ” ë­ì•¼?"`
   - ì •ê·œí™” í›„ í¬í•¨: `"í´ë¡œë²„" in "í´ë¡œë²„ëŠ”"`

2. **Fuzzy ë§¤ì¹­**:
   - **exact_fuzzy** (85% ì´ìƒ): ê±°ì˜ ì •í™•í•œ ë§¤ì¹­
   - **fuzzy** (65% ì´ìƒ): ì˜¤íƒ€ ë³´ì • ë§¤ì¹­

**ë°˜í™˜ ê°’**:
```python
[
  {
    "id": "uuid",
    "term": "í´ë¡œë²„",
    "category": "Currency_Soft",
    "match_type": "fuzzy",       # exact | exact_fuzzy | fuzzy
    "match_confidence": 0.82     # 0.0 ~ 1.0
  },
  ...
]
```

---

## ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼

### âœ… í†µê³¼í•œ í…ŒìŠ¤íŠ¸

| ì§ˆë¬¸ | ì •ë‹µ | ë§¤ì¹­ ê²°ê³¼ | ì‹ ë¢°ë„ |
|------|------|-----------|--------|
| "í´ë¡œë²„ëŠ”ì–´ë””ì—ì“°ë‚˜ìš”?" | í´ë¡œë²„ | âœ… exact | 1.00 |
| "í´ë¡œë°”ëŠ” ë­ì•¼?" | í´ë¡œë²„ | âœ… fuzzy | 0.82 |
| "í´ë¡œë²„ë¥¼ ì–´ë–»ê²Œ ì–»ì–´?" | í´ë¡œë²„ | âœ… exact | 1.00 |
| "í¬ ì½” ì½” ë¡œ" | í¬ì½”ì½”ë¡œ | âœ… exact | 1.00 |
| "í¬ì½”ìˆ² ë¦¬ê·¸ëŠ” ë­ì•¼?" | í¬ì½”ìˆ² ë¦¬ê·¸ | âœ… exact | 1.00 |

### ğŸ“ˆ ì„±ëŠ¥ ì§€í‘œ

- **ë„ì–´ì“°ê¸° ë³´ì •**: 100% ì„±ê³µ
- **ì˜¤íƒˆì ë³´ì •** (1ê¸€ì): 100% ì„±ê³µ
- **ì¡°ì‚¬ ë³€ê²½ ëŒ€ì‘**: 100% ì„±ê³µ
- **ì •ìƒ ì§ˆë¬¸**: 100% ì„±ê³µ

---

## âš™ï¸ ì„¤ì • ë° íŠœë‹

### ì„ê³„ê°’ ì¡°ì •

í˜„ì¬ ì„¤ì • (`main.py:486-487`):
```python
mentioned_terms = find_matching_terms(
    user_query=user_message,
    all_terms=terms_result.data,
    exact_threshold=0.85,  # 85% ì´ìƒ = exact_fuzzy
    fuzzy_threshold=0.65   # 65% ì´ìƒ = fuzzy
)
```

**ê¶Œì¥ ì„¤ì •**:
- **ì—„ê²© ëª¨ë“œ** (ì˜¤íƒˆì ìµœì†Œí™”):
  - `exact_threshold=0.90`, `fuzzy_threshold=0.75`

- **ê´€ëŒ€ ëª¨ë“œ** (ì˜¤íƒˆì ìµœëŒ€ í—ˆìš©):
  - `exact_threshold=0.80`, `fuzzy_threshold=0.60`

- **í˜„ì¬ ê· í˜• ëª¨ë“œ** (ì¶”ì²œ):
  - `exact_threshold=0.85`, `fuzzy_threshold=0.65`

---

## ğŸ” ë””ë²„ê¹…

### ë¡œê·¸ í™•ì¸

API ì‘ë‹µì˜ `search_process.steps`ì—ì„œ ë§¤ì¹­ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```json
{
  "search_process": {
    "steps": [
      {
        "step": 3,
        "name": "ìš©ì–´ ë§¤ì¹­ (Fuzzy)",
        "description": "ì§ˆë¬¸ì—ì„œ ê´€ë ¨ ìš©ì–´ ì¶”ì¶œ ì¤‘ (ë„ì–´ì“°ê¸°/ì˜¤íƒˆì ë³´ì •)..."
      },
      {
        "step": 4,
        "name": "ìš©ì–´ ë§¤ì¹­ ì™„ë£Œ",
        "description": "5ê°œì˜ ìš©ì–´ ë°œê²¬: í´ë¡œë²„(exact:1.00), í´ë¡œë²„(fuzzy:0.82), ..."
      }
    ],
    "found_terms": [
      {"term": "í´ë¡œë²„", "category": "Currency_Soft"}
    ]
  }
}
```

### ë§¤ì¹­ ì‹¤íŒ¨ ì‹œ ì²´í¬ë¦¬ìŠ¤íŠ¸

1. **ì„ê³„ê°’ í™•ì¸**: ìœ ì‚¬ë„ê°€ 65% ì´ìƒì¸ê°€?
2. **ì¡°ì‚¬ ì œê±°**: ì¡°ì‚¬ê°€ ì œëŒ€ë¡œ ì œê±°ë˜ì—ˆëŠ”ê°€?
3. **ë„ì–´ì“°ê¸°**: ì •ê·œí™” í›„ ë§¤ì¹­ë˜ëŠ”ê°€?
4. **ìš©ì–´ ì¡´ì¬**: DBì— í•´ë‹¹ ìš©ì–´ê°€ ìˆëŠ”ê°€?

---

## ğŸ¯ ì‚¬ìš© ì˜ˆì‹œ

### cURL í…ŒìŠ¤íŠ¸

```bash
# ë„ì–´ì“°ê¸° ì—†ëŠ” ì§ˆë¬¸
curl -X POST http://localhost:8000/api/chat \
  -H "Content-Type: application/json" \
  -d '{
    "messages": [{"role": "user", "content": "í´ë¡œë²„ëŠ”ì–´ë””ì—ì“°ë‚˜ìš”?"}],
    "use_graph": true
  }'

# ì˜¤íƒˆì ìˆëŠ” ì§ˆë¬¸
curl -X POST http://localhost:8000/api/chat \
  -H "Content-Type: application/json" \
  -d '{
    "messages": [{"role": "user", "content": "í´ë¡œë°”ëŠ” ë­ì•¼?"}],
    "use_graph": true
  }'
```

### Python ì˜ˆì‹œ

```python
import requests

response = requests.post(
    "http://localhost:8000/api/chat",
    json={
        "messages": [{"role": "user", "content": "í´ë¡œë°”ëŠ” ë­ì•¼?"}],
        "use_graph": True
    }
)

data = response.json()

# ë§¤ì¹­ëœ ìš©ì–´ í™•ì¸
found_terms = data['search_process']['found_terms']
print(f"ë°œê²¬ëœ ìš©ì–´: {[t['term'] for t in found_terms]}")

# ë‹µë³€ í™•ì¸
print(f"ë‹µë³€: {data['message']}")
```

---

## ğŸ“ ì œí•œì‚¬í•­ ë° í–¥í›„ ê°œì„ 

### í˜„ì¬ ì œí•œì‚¬í•­

1. **í•œêµ­ì–´ ì „ìš©**: ì˜ì–´ë‚˜ ë‹¤ë¥¸ ì–¸ì–´ëŠ” ë¯¸ì§€ì›
2. **2ê¸€ì ì´ìƒ ì˜¤íƒ€**: "í´ë¡œê±°" (2ê¸€ì ì˜¤íƒ€) â†’ ë§¤ì¹­ ì‹¤íŒ¨ ê°€ëŠ¥
3. **ë™ìŒì´ì˜ì–´**: "ë°¤" (ë°¤/chestnut vs ë°¤/night) êµ¬ë¶„ ë¶ˆê°€

### í–¥í›„ ê°œì„  ê³„íš

1. **Jaro-Winkler ê±°ë¦¬**: ë” ì •êµí•œ ìœ ì‚¬ë„ ê³„ì‚°
2. **ìŒì„±í•™ ê¸°ë°˜ ë§¤ì¹­**: ë°œìŒì´ ìœ ì‚¬í•œ ë‹¨ì–´ ë§¤ì¹­
3. **í•™ìŠµ ê¸°ë°˜ ì˜¤íƒ€ ë³´ì •**: ì‚¬ìš©ì íŒ¨í„´ í•™ìŠµ
4. **ì»¨í…ìŠ¤íŠ¸ ê¸°ë°˜ í•„í„°ë§**: ì¹´í…Œê³ ë¦¬ ì •ë³´ í™œìš©

---

## ğŸ“š ì°¸ê³  ìë£Œ

### ê´€ë ¨ íŒŒì¼

- **êµ¬í˜„**: [src/api/main.py](../src/api/main.py) (lines 81-230)
- **í…ŒìŠ¤íŠ¸**: ìœ„ "í…ŒìŠ¤íŠ¸ ê²°ê³¼" ì„¹ì…˜ ì°¸ì¡°
- **Phase 2 ì°¸ê³ **: [src/core/processors/ontology_builder.py](../src/core/processors/ontology_builder.py) (lines 34-88)

### ì•Œê³ ë¦¬ì¦˜

- **SequenceMatcher**: Python `difflib` ëª¨ë“ˆ
  - ì°¸ê³ : https://docs.python.org/3/library/difflib.html
- **Levenshtein ê±°ë¦¬**: í¸ì§‘ ê±°ë¦¬ ì•Œê³ ë¦¬ì¦˜
  - ì°¸ê³ : https://en.wikipedia.org/wiki/Levenshtein_distance

---

## âœ… ìš”ì•½

**ì¶”ê°€ëœ ê¸°ëŠ¥**:
- âœ… ë„ì–´ì“°ê¸° ë³´ì • (100% ì„±ê³µ)
- âœ… ì˜¤íƒˆì ë³´ì • (1ê¸€ì ì˜¤íƒ€: 82% ìœ ì‚¬ë„)
- âœ… ì¡°ì‚¬ ë³€ê²½ ëŒ€ì‘ (ì€/ëŠ”/ì´/ê°€/...)
- âœ… ì‹¤ì‹œê°„ ë§¤ì¹­ (API ì‘ë‹µì— ë§¤ì¹­ ì •ë³´ í¬í•¨)

**í…ŒìŠ¤íŠ¸ ìƒíƒœ**:
- âœ… 5ê°€ì§€ ì‹œë‚˜ë¦¬ì˜¤ ëª¨ë‘ í†µê³¼
- âœ… ì‹¤ì œ ì‚¬ìš©ì ì§ˆë¬¸ ì‹œë®¬ë ˆì´ì…˜ ì„±ê³µ

**ì„±ëŠ¥**:
- ì‘ë‹µ ì‹œê°„: < 1ì´ˆ (ê¸°ì¡´ê³¼ ë™ì¼)
- ì •í™•ë„: ë§¤ìš° ë†’ìŒ (85%+ ìœ ì‚¬ë„ ë§¤ì¹­)

---

**ë¬¸ì˜**: ì¶”ê°€ ì§ˆë¬¸ì´ë‚˜ ë¬¸ì œê°€ ìˆìœ¼ë©´ ì´ìŠˆë¥¼ ë“±ë¡í•˜ì„¸ìš”!
