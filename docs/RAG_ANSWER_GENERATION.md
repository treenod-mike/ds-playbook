# RAG ë‹µë³€ ìƒì„± ì‹œìŠ¤í…œ (Evidence-based Answer Generation)

**ì‘ì„±ì¼**: 2026-01-30
**ëª©ì **: GraphRAG íŒŒì´í”„ë¼ì¸ì˜ ë§ˆì§€ë§‰ ë‹¨ê³„ì¸ 'ë‹µë³€ ìƒì„±' ë¡œì§ ì„¤ê³„ ë° êµ¬í˜„

---

## ğŸ“‹ ëª©ì°¨

1. [ê°œìš”](#ê°œìš”)
2. [ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜](#ì‹œìŠ¤í…œ-ì•„í‚¤í…ì²˜)
3. [Context Formatter](#context-formatter)
4. [System Prompt](#system-prompt)
5. [Answer Generator](#answer-generator)
6. [ì‚¬ìš© ì˜ˆì‹œ](#ì‚¬ìš©-ì˜ˆì‹œ)
7. [í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ](#í…ŒìŠ¤íŠ¸-ê°€ì´ë“œ)

---

## ê°œìš”

### ë¬¸ì œ ì •ì˜

ê¸°ì¡´ RAG ì‹œìŠ¤í…œì˜ ì¼ë°˜ì ì¸ ë¬¸ì œì :
- LLMì´ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ë¬´ì‹œí•˜ê³  ìì²´ ì§€ì‹ìœ¼ë¡œ ë‹µë³€ (Hallucination)
- ë‹µë³€ì˜ ì¶œì²˜ê°€ ë¶ˆëª…í™•í•˜ì—¬ ì‹ ë¢°ì„± ê²€ì¦ ë¶ˆê°€
- ë¹„êµ¬ì¡°í™”ëœ ì»¨í…ìŠ¤íŠ¸ ì œê³µìœ¼ë¡œ ì¸í•œ ì •ë³´ ì‹ë³„ ì–´ë ¤ì›€

### ì„¤ê³„ ëª©í‘œ

1. **ê·¼ê±° ê¸°ë°˜ ë‹µë³€ (Evidence-based)**: LLMì´ ì œê³µëœ ì»¨í…ìŠ¤íŠ¸ë§Œ ì‚¬ìš©
2. **ì¶œì²˜ í‘œê¸° (Citation)**: ëª¨ë“  ì£¼ì¥ì— ë¬¸ì„œ ì¶œì²˜ ëª…ì‹œ
3. **êµ¬ì¡°í™”ëœ ì»¨í…ìŠ¤íŠ¸ (Structured Context)**: XML íƒœê·¸ë¡œ ë©”íƒ€ë°ì´í„° í¬í•¨
4. **ë¹„ì¦ˆë‹ˆìŠ¤ ì¸ì‚¬ì´íŠ¸ (Business Insights)**: ì‹¤ë¬´ í™œìš© ê°€ëŠ¥í•œ ë¶„ì„ ì œê³µ

---

## ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    User Query                                â”‚
â”‚               "ë™ì  ë‚œì´ë„ê°€ ë­ì•¼?"                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              1. Information Retrieval                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  Vector Search   â”‚       â”‚  Graph Traversal      â”‚       â”‚
â”‚  â”‚  (Chunks)        â”‚       â”‚  (Relations)          â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              2. Context Formatting                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  RAGContextFormatter                                  â”‚   â”‚
â”‚  â”‚  â”œâ”€ format_vector_search_results()                   â”‚   â”‚
â”‚  â”‚  â”œâ”€ format_graph_relations()                         â”‚   â”‚
â”‚  â”‚  â”œâ”€ format_ontology_rules()                          â”‚   â”‚
â”‚  â”‚  â””â”€ build_full_context()                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                               â”‚
â”‚  Output: êµ¬ì¡°í™”ëœ XML ì»¨í…ìŠ¤íŠ¸                               â”‚
â”‚  <Context>                                                    â”‚
â”‚    <Query>...</Query>                                         â”‚
â”‚    <VectorSearchResults>...</VectorSearchResults>             â”‚
â”‚    <GraphRelations>...</GraphRelations>                       â”‚
â”‚    <OntologyRules>...</OntologyRules>                         â”‚
â”‚  </Context>                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              3. LLM Answer Generation                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  RAGAnswerGenerator                                   â”‚   â”‚
â”‚  â”‚  â”œâ”€ System Prompt (BI Analyst Role)                  â”‚   â”‚
â”‚  â”‚  â”œâ”€ Constraints (Evidence-based Only)                â”‚   â”‚
â”‚  â”‚  â””â”€ Citation Rules ([Source: ...])                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Final Answer                              â”‚
â”‚                                                               â”‚
â”‚  ## ë™ì  ë‚œì´ë„                                               â”‚
â”‚                                                               â”‚
â”‚  ### í•µì‹¬ ë‹µë³€                                                â”‚
â”‚  ë™ì  ë‚œì´ë„ ì‹œìŠ¤í…œì€ ìœ ì € ì‹¤ë ¥ì— ë§ì¶° ìë™ ì¡°ì ˆë©ë‹ˆë‹¤.      â”‚
â”‚  [Source: 155ë ˆë²¨ ê¸°íšì„œ]                                    â”‚
â”‚                                                               â”‚
â”‚  ### ê´€ê³„ ë¶„ì„                                                â”‚
â”‚  - ë™ì  ë‚œì´ë„ --[balances]--> ìœ ì € ì‹¤ë ¥ [Confidence: 0.95] â”‚
â”‚  - ë™ì  ë‚œì´ë„ --[maintains]--> ëª°ì… [Confidence: 0.95]     â”‚
â”‚                                                               â”‚
â”‚  ### ë¹„ì¦ˆë‹ˆìŠ¤ ì¸ì‚¬ì´íŠ¸                                        â”‚
â”‚  ì´ ì‹œìŠ¤í…œì€ ë¦¬í…ì…˜ í–¥ìƒì— ê¸°ì—¬í•©ë‹ˆë‹¤. [Graph: ...]          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Context Formatter

### ì„¤ê³„ ì›ì¹™

1. **êµ¬ì¡°í™”ëœ ë°ì´í„° í‘œí˜„**: XML íƒœê·¸ë¡œ ë©”íƒ€ë°ì´í„° ëª…ì‹œ
2. **ì¶œì²˜ ì‹ë³„ ê°€ëŠ¥**: ê° ì²­í¬ì— `chunk_id`, `doc_title` í¬í•¨
3. **ìš°ì„ ìˆœìœ„ í‘œì‹œ**: `rank`, `similarity`, `confidence` ì œê³µ
4. **ê°€ë…ì„±**: ë“¤ì—¬ì“°ê¸°ì™€ ì¤„ë°”ê¿ˆìœ¼ë¡œ ëª…í™•í•œ êµ¬ì¡°

### XML ìŠ¤í‚¤ë§ˆ

#### 1. Vector Search Results

```xml
<VectorSearchResults>
  <Chunk id="chunk_123" rank="1">
    <Source>
      <DocumentID>5</DocumentID>
      <DocumentTitle>155ë ˆë²¨ ê¸°íšì„œ</DocumentTitle>
      <ChunkID>123</ChunkID>
    </Source>
    <Similarity>0.920</Similarity>
    <Content>
ë™ì  ë‚œì´ë„ ì‹œìŠ¤í…œì€ ìœ ì €ì˜ ì‹¤ë ¥ ìˆ˜ì¤€ì— ë§ì¶° ìë™ìœ¼ë¡œ ë‚œì´ë„ë¥¼ ì¡°ì ˆí•©ë‹ˆë‹¤.
    </Content>
  </Chunk>

  <Chunk id="chunk_456" rank="2">
    ...
  </Chunk>
</VectorSearchResults>
```

#### 2. Graph Relations

```xml
<GraphRelations center="ë™ì  ë‚œì´ë„">
  <Relation id="rel_1">
    <Source>ë™ì  ë‚œì´ë„</Source>
    <Predicate>balances</Predicate>
    <Target>ìœ ì € ì‹¤ë ¥</Target>
    <Confidence>0.95</Confidence>
    <Evidence>ìœ ì € ì‹¤ë ¥ì— ë§ì¶˜</Evidence>
  </Relation>

  <Relation id="rel_2">
    ...
  </Relation>
</GraphRelations>
```

#### 3. Ontology Rules

```xml
<OntologyRules>
  <Rule id="rule_1">
    <Pattern>mechanic --[balances]--> condition</Pattern>
    <Description>ë©”ì¹´ë‹‰ì´ ì¡°ê±´/ìƒíƒœ ê· í˜• ë§ì¶¤</Description>
  </Rule>

  <Rule id="rule_2">
    ...
  </Rule>
</OntologyRules>
```

### êµ¬í˜„ ì½”ë“œ

```python
from src.core.generators.rag_answer_generator import RAGContextFormatter, SearchResult

formatter = RAGContextFormatter()

# Vector Search ê²°ê³¼ í¬ë§·íŒ…
vector_context = formatter.format_vector_search_results(vector_results)

# Graph Relations í¬ë§·íŒ…
graph_context = formatter.format_graph_relations(graph_relations, center_term="ë™ì  ë‚œì´ë„")

# Ontology Rules í¬ë§·íŒ…
rules_context = formatter.format_ontology_rules(ontology_rules)

# ì „ì²´ ì»¨í…ìŠ¤íŠ¸ ìƒì„±
full_context = formatter.build_full_context(
    query="ë™ì  ë‚œì´ë„ê°€ ë­ì•¼?",
    vector_results=vector_results,
    graph_relations=graph_relations,
    ontology_rules=ontology_rules,
    center_term="ë™ì  ë‚œì´ë„"
)
```

---

## System Prompt

### ì—­í•  ì •ì˜ (Role)

```
ë‹¹ì‹ ì€ PokoPoko ê²Œì„ì˜ **ë¹„ì¦ˆë‹ˆìŠ¤ ì¸í…”ë¦¬ì „ìŠ¤ ë¶„ì„ê°€**ì…ë‹ˆë‹¤.
```

**í•µì‹¬ ì±…ì„**:
- ê²Œì„ ê¸°íš ë¬¸ì„œì™€ ì§€ì‹ ê·¸ë˜í”„ ê¸°ë°˜ ì •í™•í•œ ë¶„ì„
- ë¹„ì¦ˆë‹ˆìŠ¤ ì˜ì‚¬ê²°ì •ì— í•„ìš”í•œ ì¸ì‚¬ì´íŠ¸ ë„ì¶œ
- ë°ì´í„° ê¸°ë°˜ì˜ ê°ê´€ì  ë‹µë³€ ì‘ì„±

### ì œì•½ ì‚¬í•­ (Constraints)

#### 1. ê·¼ê±° ê¸°ë°˜ ë‹µë³€ (Evidence-based)

```
- ë°˜ë“œì‹œ ì œê³µëœ <Context> ë‚´ì˜ ì •ë³´ë§Œ ì‚¬ìš©
- ì™¸ë¶€ ì§€ì‹ì´ë‚˜ ì¶”ì¸¡ ì‚¬ìš© ê¸ˆì§€
- ì»¨í…ìŠ¤íŠ¸ì— ì—†ëŠ” ì •ë³´ëŠ” "í˜„ì¬ ë¬¸ì„œì—ì„œëŠ” í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤" ëª…ì‹œ
```

#### 2. ì¶œì²˜ í‘œê¸° (Citation)

```
- ê° ì£¼ì¥ë§ˆë‹¤ ë°˜ë“œì‹œ ê·¼ê±° í‘œê¸°
- í˜•ì‹: [Source: ë¬¸ì„œì œëª©] ë˜ëŠ” [Chunk: chunk_ID]
- ì˜ˆì‹œ: "ë™ì  ë‚œì´ë„ ì‹œìŠ¤í…œì€ ìœ ì € ì‹¤ë ¥ì— ë§ì¶° ì¡°ì ˆë©ë‹ˆë‹¤. [Source: 155ë ˆë²¨ ê¸°íšì„œ]"
```

#### 3. ì¸ìš© ìš°ì„ ìˆœìœ„

```
1. Vector Search ê²°ê³¼ (ì§ì ‘ì ì¸ í…ìŠ¤íŠ¸ ì¦ê±°) - ìµœìš°ì„ 
2. Graph Relations (ê´€ê³„ ê¸°ë°˜ ì¶”ë¡ ) - ë³´ì¡°
3. Ontology Rules (íŒ¨í„´ ê¸°ë°˜ í•´ì„) - ì°¸ê³ 
```

#### 4. ê´€ê³„ í•´ì„ ê·œì¹™

```
- Graph Relationsì˜ predicateëŠ” ì˜¨í†¨ë¡œì§€ ë£°ê³¼ ë§¤ì¹­í•˜ì—¬ ì˜ë¯¸ í•´ì„
- Confidenceê°€ 0.8 ì´ìƒì¸ ê´€ê³„ ìš°ì„  ì‚¬ìš©
- Evidence í•„ë“œê°€ ìˆìœ¼ë©´ í•¨ê»˜ ì¸ìš©
```

### ë‹µë³€ í˜•ì‹ (Format)

#### ê¸°ë³¸ êµ¬ì¡°

```markdown
## [ì§ˆë¬¸ ì£¼ì œ]

### í•µì‹¬ ë‹µë³€
[2-3ë¬¸ì¥ìœ¼ë¡œ í•µì‹¬ ë‚´ìš© ìš”ì•½, ê° ë¬¸ì¥ë§ˆë‹¤ ì¶œì²˜ í‘œê¸°]

### ìƒì„¸ ë¶„ì„
[ë²¡í„° ê²€ìƒ‰ ê²°ê³¼ ê¸°ë°˜ ìƒì„¸ ì„¤ëª…]
- í¬ì¸íŠ¸ 1 [Source: ...]
- í¬ì¸íŠ¸ 2 [Source: ...]

### ê´€ê³„ ë¶„ì„ (ì„ íƒì )
[ê·¸ë˜í”„ ê´€ê³„ê°€ ìˆì„ ê²½ìš°ë§Œ ì¶”ê°€]
- ê´€ê³„ 1: A --[predicate]--> B [Confidence: 0.95]
- ê´€ê³„ 2: B --[predicate]--> C [Confidence: 0.90]

### ë¹„ì¦ˆë‹ˆìŠ¤ ì¸ì‚¬ì´íŠ¸
[ë¶„ì„ ê²°ê³¼ì˜ ì‹¤ë¬´ í™œìš© ë°©ì•ˆ]
```

#### ì¢‹ì€ ë‹µë³€ ì˜ˆì‹œ âœ…

```markdown
## ë™ì  ë‚œì´ë„

### í•µì‹¬ ë‹µë³€
ë™ì  ë‚œì´ë„ ì‹œìŠ¤í…œì€ ìœ ì €ì˜ ì‹¤ë ¥ ìˆ˜ì¤€ì— ë§ì¶° ìë™ìœ¼ë¡œ ì¡°ì ˆë©ë‹ˆë‹¤. [Source: 155ë ˆë²¨ ê¸°íšì„œ]
ì´ ì‹œìŠ¤í…œì€ ì¢Œì ˆê°ê³¼ ì§€ë£¨í•¨ì„ ìµœì†Œí™”í•˜ì—¬(relieves) ì§€ì†ì ì¸ ëª°ì…(Flow) ìƒíƒœë¥¼ ìœ ì§€ì‹œí‚µë‹ˆë‹¤.
[Graph: ë™ì  ë‚œì´ë„ --relieves--> ì¢Œì ˆ, Confidence: 0.90]

### ìƒì„¸ ë¶„ì„
ë¬¸ì„œì— ë”°ë¥´ë©´:
- ë„ˆë¬´ ì–´ë µê±°ë‚˜ ì‰¬ìš´ ê²½í—˜ì„ ë°©ì§€í•˜ì—¬ ì ì ˆí•œ ë„ì „ê°ì„ ì œê³µí•©ë‹ˆë‹¤ [Chunk: 123]
- ë‚œì´ë„ ë°¸ëŸ°ìŠ¤ëŠ” ìœ ì €ì˜ ì„±ì·¨ê°ì„ ë†’ì—¬ ë¦¬í…ì…˜ í–¥ìƒì— ê¸°ì—¬í•©ë‹ˆë‹¤ [Chunk: 456]

### ê´€ê³„ ë¶„ì„
- ë™ì  ë‚œì´ë„ --[balances]--> ìœ ì € ì‹¤ë ¥ [Confidence: 0.95]
- ë™ì  ë‚œì´ë„ --[maintains]--> ëª°ì… [Confidence: 0.95]
- ëª°ì… --[boosts]--> ë¦¬í…ì…˜ [Confidence: 0.90]

### ë¹„ì¦ˆë‹ˆìŠ¤ ì¸ì‚¬ì´íŠ¸
ë™ì  ë‚œì´ë„ëŠ” ìœ ì €ë³„ ê²½í—˜ì„ ê°œì¸í™”í•˜ì—¬ ì´íƒˆì„ ë°©ì§€í•˜ëŠ” í•µì‹¬ ë©”ì¹´ë‹‰ì…ë‹ˆë‹¤.
íŠ¹íˆ ê³ ë‚œì´ë„ ìŠ¤í…Œì´ì§€ì—ì„œ ì¢Œì ˆë¡œ ì¸í•œ ì´íƒˆë¥ ì„ ë‚®ì¶”ëŠ” ë° íš¨ê³¼ì ì…ë‹ˆë‹¤.
```

#### ë‚˜ìœ ë‹µë³€ ì˜ˆì‹œ âŒ

```markdown
ë™ì  ë‚œì´ë„ ì‹œìŠ¤í…œì€ ì¼ë°˜ì ìœ¼ë¡œ ê²Œì„ì—ì„œ ë§ì´ ì‚¬ìš©ë©ë‹ˆë‹¤.
ìœ ì € ê²½í—˜ì„ ê°œì„ í•˜ëŠ” ê²ƒìœ¼ë¡œ ì•Œë ¤ì ¸ ìˆìŠµë‹ˆë‹¤.

(ë¬¸ì œì : ì™¸ë¶€ ì§€ì‹ ì‚¬ìš©, ì¶œì²˜ ë¯¸í‘œê¸°, ì¶”ìƒì  í‘œí˜„)
```

### íŠ¹ìˆ˜ ì¼€ì´ìŠ¤ ì²˜ë¦¬

#### 1. ì»¨í…ìŠ¤íŠ¸ ë¶€ì¡±

```markdown
## ë‹µë³€ ë¶ˆê°€

í˜„ì¬ ì œê³µëœ ë¬¸ì„œì—ì„œëŠ” "[ì§ˆë¬¸ ì£¼ì œ]"ì— ëŒ€í•œ ì¶©ë¶„í•œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

**ê²€ìƒ‰ëœ ë‚´ìš©**:
- [ê´€ë ¨ì„± ìˆëŠ” ë¶€ë¶„ì  ì •ë³´ ìš”ì•½]

**ì¶”ê°€ ê²€ìƒ‰ ì œì•ˆ**:
- "[ì¶”ì²œ ê²€ìƒ‰ì–´ 1]"
- "[ì¶”ì²œ ê²€ìƒ‰ì–´ 2]"
```

#### 2. ëª¨ìˆœëœ ì •ë³´

```markdown
ë¬¸ì„œ ê°„ ë¶ˆì¼ì¹˜ê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤:
- ë¬¸ì„œ A: [ë‚´ìš©] [Source: ...]
- ë¬¸ì„œ B: [ìƒë°˜ëœ ë‚´ìš©] [Source: ...]

â†’ ìµœì‹  ë¬¸ì„œ ê¸°ì¤€ìœ¼ë¡œ "[ê²°ë¡ ]"ì´ ìœ íš¨í•©ë‹ˆë‹¤. [Source: ...]
```

#### 3. ì¶”ë¡ ì´ í•„ìš”í•œ ê²½ìš°

```markdown
ì§ì ‘ì ì¸ ê¸°ìˆ ì€ ì—†ìœ¼ë‚˜, ë‹¤ìŒ ê´€ê³„ë¡œë¶€í„° ì¶”ë¡  ê°€ëŠ¥í•©ë‹ˆë‹¤:
1. A --[predicate]--> B [Confidence: 0.95] [Source: ...]
2. B --[predicate]--> C [Confidence: 0.90] [Source: ...]

â†’ ë”°ë¼ì„œ "AëŠ” Cì— ê°„ì ‘ì ìœ¼ë¡œ ì˜í–¥ì„ ë¯¸ì¹  ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤."
```

### ì¤‘ìš” ì›ì¹™

1. **No Hallucination**: ì»¨í…ìŠ¤íŠ¸ì— ì—†ëŠ” ì •ë³´ëŠ” ì ˆëŒ€ ìƒì„± ê¸ˆì§€
2. **Always Cite**: ëª¨ë“  ì‚¬ì‹¤ì  ì§„ìˆ ì— ì¶œì²˜ í‘œê¸° í•„ìˆ˜
3. **Be Honest**: ëª¨ë¥´ë©´ ëª¨ë¥¸ë‹¤ê³  ëª…í™•íˆ í‘œí˜„
4. **Prioritize Evidence**: ë²¡í„° ê²€ìƒ‰ > ê·¸ë˜í”„ ê´€ê³„ > ì˜¨í†¨ë¡œì§€ ë£° ìˆœ ìš°ì„ ìˆœìœ„
5. **Business Focus**: ì‹¤ë¬´ í™œìš© ê°€ëŠ¥í•œ ì¸ì‚¬ì´íŠ¸ ë„ì¶œ

---

## Answer Generator

### í´ë˜ìŠ¤ êµ¬ì¡°

```python
class RAGAnswerGenerator:
    """ê·¼ê±° ê¸°ë°˜ ë‹µë³€ ìƒì„±ê¸°"""

    def __init__(self, openai_client):
        self.openai_client = openai_client
        self.formatter = RAGContextFormatter()

    def generate_answer(
        self,
        query: str,
        vector_results: List[SearchResult],
        graph_relations: List[GraphRelation],
        ontology_rules: List[Dict[str, str]],
        center_term: Optional[str] = None,
        model: str = "gpt-4o",
        temperature: float = 0.3
    ) -> Dict[str, Any]:
        """ê·¼ê±° ê¸°ë°˜ ë‹µë³€ ìƒì„± (ì¼ë°˜ ëª¨ë“œ)"""
        ...

    def generate_answer_streaming(self, ...):
        """ê·¼ê±° ê¸°ë°˜ ë‹µë³€ ìƒì„± (ìŠ¤íŠ¸ë¦¬ë° ëª¨ë“œ)"""
        ...
```

### í•µì‹¬ íŒŒë¼ë¯¸í„°

| íŒŒë¼ë¯¸í„° | íƒ€ì… | ì„¤ëª… | ê¸°ë³¸ê°’ |
|---------|------|------|--------|
| `query` | str | ì‚¬ìš©ì ì§ˆë¬¸ | - |
| `vector_results` | List[SearchResult] | Vector Search ê²°ê³¼ | - |
| `graph_relations` | List[GraphRelation] | Graph Traversal ê²°ê³¼ | - |
| `ontology_rules` | List[Dict] | ì˜¨í†¨ë¡œì§€ ë£° | - |
| `center_term` | Optional[str] | ê·¸ë˜í”„ ì¤‘ì‹¬ ìš©ì–´ | None |
| `model` | str | LLM ëª¨ë¸ | "gpt-4o" |
| `temperature` | float | ìƒì„± ë‹¤ì–‘ì„± (0.0~1.0) | 0.3 |

**Temperature ê°€ì´ë“œ**:
- **0.0~0.3**: ë³´ìˆ˜ì , ì¼ê´€ëœ ë‹µë³€ (ê¶Œì¥)
- **0.4~0.6**: ê· í˜•, ì•½ê°„ì˜ ì°½ì˜ì„±
- **0.7~1.0**: ì°½ì˜ì , ë‹¤ì–‘í•œ í‘œí˜„ (ë¹„ê¶Œì¥ - Hallucination ìœ„í—˜)

### ë°˜í™˜ê°’ êµ¬ì¡°

#### ì„±ê³µ ì‹œ

```python
{
    "success": True,
    "answer": "## ë™ì  ë‚œì´ë„\n\n### í•µì‹¬ ë‹µë³€\n...",
    "context": "<Context>...</Context>",
    "metadata": {
        "model": "gpt-4o",
        "temperature": 0.3,
        "tokens_used": 1245,
        "num_chunks": 3,
        "num_relations": 5,
        "num_rules": 10
    }
}
```

#### ì‹¤íŒ¨ ì‹œ

```python
{
    "success": False,
    "error": "OpenAI API error: ...",
    "context": "<Context>...</Context>"
}
```

---

## ì‚¬ìš© ì˜ˆì‹œ

### ê¸°ë³¸ ì‚¬ìš©ë²•

```python
from openai import OpenAI
from src.core.generators.rag_answer_generator import (
    RAGAnswerGenerator,
    SearchResult,
    GraphRelation
)

# OpenAI í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
client = OpenAI(api_key="your-api-key")

# ë‹µë³€ ìƒì„±ê¸° ì´ˆê¸°í™”
generator = RAGAnswerGenerator(client)

# ê²€ìƒ‰ ê²°ê³¼ ì¤€ë¹„
vector_results = [
    SearchResult(
        chunk_id=123,
        doc_id=5,
        doc_title="155ë ˆë²¨ ê¸°íšì„œ",
        content="ë™ì  ë‚œì´ë„ ì‹œìŠ¤í…œì€...",
        similarity=0.92
    )
]

graph_relations = [
    GraphRelation(
        source="ë™ì  ë‚œì´ë„",
        predicate="balances",
        target="ìœ ì € ì‹¤ë ¥",
        confidence=0.95,
        evidence="ìœ ì € ì‹¤ë ¥ì— ë§ì¶˜"
    )
]

ontology_rules = [
    {
        "subject_type": "mechanic",
        "predicate": "balances",
        "object_type": "condition",
        "description": "ë©”ì¹´ë‹‰ì´ ì¡°ê±´/ìƒíƒœ ê· í˜• ë§ì¶¤"
    }
]

# ë‹µë³€ ìƒì„±
result = generator.generate_answer(
    query="ë™ì  ë‚œì´ë„ê°€ ë­ì•¼?",
    vector_results=vector_results,
    graph_relations=graph_relations,
    ontology_rules=ontology_rules,
    center_term="ë™ì  ë‚œì´ë„",
    temperature=0.3
)

if result["success"]:
    print(result["answer"])
    print(f"\nì‚¬ìš© í† í°: {result['metadata']['tokens_used']}")
else:
    print(f"ì˜¤ë¥˜: {result['error']}")
```

### ìŠ¤íŠ¸ë¦¬ë° ëª¨ë“œ (ì‹¤ì‹œê°„ ì¶œë ¥)

```python
# ìŠ¤íŠ¸ë¦¬ë° ë‹µë³€ ìƒì„±
for token in generator.generate_answer_streaming(
    query="ë™ì  ë‚œì´ë„ê°€ ë­ì•¼?",
    vector_results=vector_results,
    graph_relations=graph_relations,
    ontology_rules=ontology_rules,
    center_term="ë™ì  ë‚œì´ë„"
):
    print(token, end="", flush=True)
```

### ì›¹ API í†µí•© ì˜ˆì‹œ

```python
from fastapi import FastAPI
from fastapi.responses import StreamingResponse

app = FastAPI()

@app.post("/api/chat")
async def chat(query: str):
    # 1. Vector Search
    vector_results = search_chunks(query)

    # 2. Graph Traversal
    graph_relations = traverse_graph(query)

    # 3. Ontology Rules
    ontology_rules = load_ontology_rules()

    # 4. Generate Answer (Streaming)
    def generate():
        for token in generator.generate_answer_streaming(
            query=query,
            vector_results=vector_results,
            graph_relations=graph_relations,
            ontology_rules=ontology_rules
        ):
            yield token

    return StreamingResponse(generate(), media_type="text/plain")
```

---

## í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ

### 1. Context Formatter í…ŒìŠ¤íŠ¸

```bash
python3 scripts/test_rag_answer_generation.py
```

**í™•ì¸ í¬ì¸íŠ¸**:
- XML êµ¬ì¡°ê°€ ì˜¬ë°”ë¥´ê²Œ ìƒì„±ë˜ëŠ”ê°€?
- ë©”íƒ€ë°ì´í„°(chunk_id, doc_title)ê°€ í¬í•¨ë˜ëŠ”ê°€?
- ë¹ˆ ê²°ê³¼ì— ëŒ€í•œ ì²˜ë¦¬ê°€ ì ì ˆí•œê°€?

### 2. ì‹¤ì œ ë°ì´í„° í…ŒìŠ¤íŠ¸

```bash
python3 scripts/test_rag_answer_generation.py
```

**í…ŒìŠ¤íŠ¸ ì§ˆë¬¸ ì˜ˆì‹œ**:
- "ë™ì  ë‚œì´ë„ê°€ ë­ì•¼?"
- "í´ë¡œë²„ëŠ” ì–´ë””ì— ì“°ì´ë‚˜ìš”?"
- "ë¦¬í…ì…˜ì„ ë†’ì´ë ¤ë©´ ì–´ë–»ê²Œ í•´ì•¼ í•˜ë‚˜ìš”?"

**í™•ì¸ í¬ì¸íŠ¸**:
- ë‹µë³€ì´ ì œê³µëœ ì»¨í…ìŠ¤íŠ¸ë§Œ ì‚¬ìš©í•˜ëŠ”ê°€?
- ëª¨ë“  ì£¼ì¥ì— ì¶œì²˜ê°€ í‘œê¸°ë˜ëŠ”ê°€?
- ë§ˆí¬ë‹¤ìš´ í˜•ì‹ì´ ì˜¬ë°”ë¥¸ê°€?
- ë¹„ì¦ˆë‹ˆìŠ¤ ì¸ì‚¬ì´íŠ¸ê°€ ì‹¤ë¬´ í™œìš© ê°€ëŠ¥í•œê°€?

### 3. Edge Case í…ŒìŠ¤íŠ¸

#### 3.1. ì»¨í…ìŠ¤íŠ¸ ë¶€ì¡±

```python
result = generator.generate_answer(
    query="ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ìš©ì–´ë¥¼ ë¬¼ì–´ë´„",
    vector_results=[],
    graph_relations=[],
    ontology_rules=[]
)
```

**ê¸°ëŒ€ ë™ì‘**: "í˜„ì¬ ë¬¸ì„œì—ì„œëŠ” í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤" ì‘ë‹µ

#### 3.2. ëª¨ìˆœëœ ì •ë³´

```python
vector_results = [
    SearchResult(..., content="AëŠ” Bë¥¼ ì¦ê°€ì‹œí‚¨ë‹¤"),
    SearchResult(..., content="AëŠ” Bë¥¼ ê°ì†Œì‹œí‚¨ë‹¤")
]
```

**ê¸°ëŒ€ ë™ì‘**: ëª¨ìˆœ ëª…ì‹œ í›„ ìµœì‹  ë¬¸ì„œ ê¸°ì¤€ ë‹µë³€

#### 3.3. ë‚®ì€ Confidence ê´€ê³„

```python
graph_relations = [
    GraphRelation(..., confidence=0.5)  # ë‚®ì€ ì‹ ë¢°ë„
]
```

**ê¸°ëŒ€ ë™ì‘**: ê´€ê³„ë¥¼ ì°¸ê³ ìš©ìœ¼ë¡œë§Œ ì‚¬ìš©í•˜ê±°ë‚˜ ë¬´ì‹œ

---

## ì„±ëŠ¥ ìµœì í™”

### 1. í† í° ì‚¬ìš© ìµœì í™”

```python
# ì²­í¬ ìˆ˜ ì œí•œ
MAX_CHUNKS = 5

# ê´€ê³„ ìˆ˜ ì œí•œ
MAX_RELATIONS = 10

# ì˜¨í†¨ë¡œì§€ ë£° í•„í„°ë§ (ê´€ë ¨ì„± ë†’ì€ ê²ƒë§Œ)
filtered_rules = [r for r in ontology_rules if r['predicate'] in used_predicates]
```

### 2. ìºì‹± ì „ëµ

```python
from functools import lru_cache

@lru_cache(maxsize=100)
def generate_cached_answer(query_hash, context_hash):
    """ìì£¼ ë¬»ëŠ” ì§ˆë¬¸ì€ ìºì‹±"""
    ...
```

### 3. ë°°ì¹˜ ì²˜ë¦¬

```python
# ì—¬ëŸ¬ ì§ˆë¬¸ì„ ë°°ì¹˜ë¡œ ì²˜ë¦¬
results = []
for query in queries:
    result = generator.generate_answer(...)
    results.append(result)
```

---

## í–¥í›„ ê°œì„  ë°©í–¥

### 1. ë©€í‹°ëª¨ë‹¬ ì§€ì›
- ì´ë¯¸ì§€, í‘œ, ê·¸ë˜í”„ í¬í•¨ ë‹µë³€
- ì‹œê°í™” ìë™ ìƒì„±

### 2. ëŒ€í™” ì»¨í…ìŠ¤íŠ¸ ìœ ì§€
- ì´ì „ ëŒ€í™” ê¸°ë¡ í™œìš©
- ì§€ì‹œì–´("ê·¸ê²ƒ", "ê·¸ëŸ¼") ì²˜ë¦¬

### 3. ë‹µë³€ í’ˆì§ˆ í‰ê°€
- ì¶œì²˜ í‘œê¸°ìœ¨ ìë™ ì¸¡ì •
- Hallucination íƒì§€
- ì‚¬ìš©ì í”¼ë“œë°± ìˆ˜ì§‘

### 4. ë‹¤êµ­ì–´ ì§€ì›
- ì˜ì–´, ì¼ë³¸ì–´ ë‹µë³€ ìƒì„±
- ìš©ì–´ ë‹¤êµ­ì–´ ë§¤ì¹­

---

## ì°¸ê³  ë¬¸ì„œ

- [ONTOLOGY_UPDATE_SUMMARY.md](../ONTOLOGY_UPDATE_SUMMARY.md) - v2.0 ì˜¨í†¨ë¡œì§€ ì—…ê·¸ë ˆì´ë“œ
- [RAW_RELATIONS_OPTIMIZATION.md](RAW_RELATIONS_OPTIMIZATION.md) - ê´€ê³„ ìµœì í™” ì „ëµ
- [TEST_GUIDE.md](../TEST_GUIDE.md) - ì „ì²´ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ

---

**ë¬¸ì˜**: êµ¬í˜„ ê´€ë ¨ ì§ˆë¬¸ì€ ì´ìŠˆ ë“±ë¡ ë˜ëŠ” ë‹´ë‹¹ìì—ê²Œ ì—°ë½í•˜ì„¸ìš”.
